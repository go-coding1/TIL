# MSA 개념 정립하기

이 글은 아래 블로그의 내용을 공부할 겸 정리하였습니다.

출저 : [블로그](https://waspro.tistory.com/429?category=857035)

---

Microservice는 SOA(Service Oriented Architecture)의 경량화 버전으로(Service : 특정 기능의 집합, service의 범위 정의가 중요) 모놀리틱 아키텍처(monolithic architecture)를 쪼개서 독립적으로 구분합니다.

> 모놀리틱 아키텍처(Monolithic Architecture)
>
> 기존 legacy System의 경우 monolithic 아키텍처를 따르는 large 어플리케이션들은 다음과 같은 개발/운영상의 문제들에 직면하게 됩니다.
>
> 1. 일부 모듈의 변경사항 때문에 전체 어플리케이션 개발/운영 프로세스와 패키징에 영향을 준다.
> 2. 모듈별 특성에 맞는 신기술 또는 구조를 적용하기 어렵다.
> 3. 모듈별 확장이 어렵다.

Microservice는 독립적으로 Deploy/Extends 될수 있는 서비스들을 조합하여 large 어플리케이션을 구성하는 아키텍처 패턴입니다. 

일반적으로 Service Discovery, API Gateway, Orchestration, Choreography, Context Boundary등의 서비스들의 조합으로 이루어져있습니다.

Netflix, Twitter, Amazon, Nike 등의 회사에서 채택한 아키텍처로 소개되면서 14년 초반부터 현재까지 주목 받고 있습니다. 아키텍처 관련 기술 표준은 없으며 SW벤더들이 기존 제품군(SOA, PaaS,...)을 Microservices를 지원하기 위한 플랫폼으로 reband하는 추세로 전환되고 있습니다.

### MSA의 특징

마이크로서비스 아키텍처의 특징은 다음과 같습니다.

1. 애플리케이션 로직을 각자 책임이 명확한 작은 컴포넌트들로 분해하고 이들을 조합해서 솔루션을 제공한다.
2. 각 컴포넌트는 작은 책임 영역을 담당하고 완전히 상호 독립적으로 배포된다. 마이크로서비스는 비즈니스 영역의 한 부분에만 책임을 담당한다. 그리고 여러 애플리케이션에서 재상용할 수 있어야 한다.
3. 마이크로서비스는 몇가지 기본 원칙에 기반을 두며, 서비스 소비자와 서비스 제공자 사이의 데이터 교환을 위해 HTTP와 JSON같은 경량 통신 프로토콜을 사용한다.
4. 애플리케이션은 항상 기술 중립적으로 프로토콜을 사용해 통신하므로 서비스 구현 기술과는 무관하다. 따라서 마이크로서비스 기반의 애플리케이션을 다양한 언어와 기술로 구축할 수 있다는 것을 의미한다.
5. 작고 독립적이며 분산된 마이크로서비스를 사용해 조직은 명확히 정의된 책임 영역을 담당하는 소규모 팀을 보유할 수 있다. 이 팀들은 애플리케이션 출시처럼 하나의 목표를 향해 일하지만, 자기가 개발하는 서비스만 책임진다.

### MSA의 장단점

Microservice가 등장한지 꽤 되었지만, 사실 중요성을 인지한지는 그리 오래되지 않았습니다. 다만 최근 MSA의 급격한 성장세에 너도나도 뛰어들고 있는 추세입니다. 그렇다면 왜 MSA를 사용하는가에 대한 의문을 갖게되는데요 바로 다음과 같은 이유입니다.

1. 작은 서비스들로 나누고, 각 서비스를 독립적으로 만들게 되어서 loosel-coupled 결합도가 낮아진다.
2. 대용량 분산 환경에 적합
3. 복잡도 감소
4. 유연한 배포
5. 재사용성 -> 확장성
6. 서비스별 hw/sw 플래폿/기술의 도입 및 확장이 자유롭다.
7. 개발자가 이해하기 쉽고 개발/운영 매 단계의 생산성이 높다.
8. 지속적인 개발/디플로이가 biz capability단위로 관련된 소수의 인원의 책임하에 이루어질 수 있다.
9. fault isolation 특성이 좋다.

Microservice의 장점은 위와 같이 강력하지만 이는 단순히 장점만 포함하고 있는 것이 아닙니다. Microserivce를 성공적으로 활용하기 위해서는 아래와 같은 문제에 대한 대책을 사전에 마련해야 합니다.

| 단점                                                         | 보완방법                                                     |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| 장애추적, 모니터링, 매지징이 어렵다                          | Sleuth등과 ELK, EFK 등의 서비스를 연동하여 사용하는 방안 고려 |
| 여러 서비스에 걸쳐져 있는 feature의 경우, 트랜잭션을 다루기 어렵다. | 보상 트랜잭션 또는 부분적으로 composite서비스로의 병합 고려  |
| 여러 서비스에 걸쳐져 있는 feature의 경우, 테스팅이 복잡하다. | 테스팅 계획 및 방법에 노력 투자                              |
| 서비스 간 dependency가 있는 경우 릴리즈가 까다롭다.          | 관련 개발조직 간 roll-out 계획 마련 및 dependency의 명백한 관리 |
| 서비스 개수가 많고 유동적이기때문에 Continuous Integration/Delivery 및 서비스 관리 상의 문제가 발생할 수 있다. | 서비스 레지스트리, 모니터링, 개발-디플로이 자동화 기술 고려(PaaS 고려) |
| monolith로 시작한 시스템을 Microservices로 전환할 때 큰 고통이 수반될 수 있다. | B2C웹 또는 SaaS어플리케이션은 처음부터 Microservices 및 서비스별 조직 구성 고려 |

---

# MSA 표준 아키텍처

Microservice는 SOA(Service Oriented Architecture)의 경량화 버전으로 (Service : 특정 기능의 집합, serivce의 범위 정의가 중요) 모놀로틱 아키텍처를 쪼개서 독립적으로 구분합니다.

Microservice는 독립적으로 디플로이/확장될 수 있는 서비스들을 조합하여 large 어플리케이션을 구성하는 아키텍처 패턴입니다. 일반적으로 Service Discovery, API Gateway, Orchestration, Choreography, Context Boundary등의 서비스들의 조합으로 이루어져있습니다.

Netflix, Twitter, Amazon, Nike 등의 회사에서 채택한 아키텍처로 소개되며서 14년 초반부터 현재까지 주목 받고 있습니다. 아키텍처 관련 기술 표준은 없으며 SW벤더들이 기존 제품군을 Microservices를 지원하기 위한 플랫폼으로서 rebrand하는 추세로 전환되고 있습니다.

#### MSA 아키텍처 표준 구성 요소

![MSA7](https://user-images.githubusercontent.com/54675591/119944736-99899c00-bfcf-11eb-9580-83977696adaa.png)

위 이미지는 일반적인 MSA 아키텍처 패턴의 흐름입니다. 표준이라고 정의 할 수 있는 패턴이 없기에 ㄱ인적으로 가장 많이 사용하고 대중적 요소만 담은 아키텍처 패턴입니다.

유저들은 모바일 도는 PC등으로 인터넷에 접속합니다.

1. API Gateway는 API를 통해 접근하는 모든 서비스들에게 Policy Management, Mediation, Aggregation, Consumer Identify Provider를 제공합니다. 일반적으로는 사용자가 접근하면 인증을 처리하는 역할 및 원하는 서비스로 바인딩하는 역할을 수행합니다. API Gateway를 External Gateway로 부르기도 합니다.
2. Service Mesh는 MSA의 핵심이라고 할 수 있습니다. Service Discovery의 동적 서비스 확장, Service Router의 로드밸런싱, Configuration의 설정 통합관리 등은 API의 유입을 통제하는 중요ㅛ한 기능이라 할 수 있습니다. 비즈니스 로직이 수행되며 이는 Database or Message Broker 등의 Backing Service로 연결됩니다. Service Mesh를 Internal Gateway라고 부르기도 합니다.
3. 그 밖에 실제 마이크로서비스가 적재되는 Container와 Monitoring / Loggin / Tracing등의 모듈로 구성됩니다.

* 비즈니스 도메인

비즈니스 도메인의 분석은 애플리케이션을 개발할 때 가장 중요한 부분 중 하나입니다. 소프트웨어 시스템과 관련있는 주요 엔티티를 식별하고, 모든 엔티티는 비즈니스를 개념적으로 바라보는 관점에서 찾아야 하며, 이것을 비즈니스 모델이라고 합니다.

![msa8](https://user-images.githubusercontent.com/54675591/119946162-4c0e2e80-bfd1-11eb-9da7-679b2cd6836f.png)

# MSA 아키텍처 패턴(Client, 운영자, 개발자 측면의 흐름)

![msa9](https://user-images.githubusercontent.com/54675591/119946657-d5256580-bfd1-11eb-85f6-7d6c009848d3.png)

본 이미지는 Gartner에 게시된 Microservice Architecture Components입니다.

앞서 살펴보았던 표준 아키텍처를 보다 도식화 하여 상세히 풀어놓았습니다.

* 관리 컨테이너 : 개별 서비스 인스턴스에는 작동 할 컨텍스트가 필요합니다. 가상 컴퓨터, Docker 컨테이너 또는 조정 된 프로세스로 구현 된 관리 컨테이너는 이러한 기능을 제공합니다. 이 구성 요소는 인스턴스 관리 및 조정을 제공하고 필요에 따라 새 인스턴스를 회전하며 개별 인스턴스의 수명주기를 관리합니다.
* 외부 게이트웨이 : MSA 구현은 비즈니스 응용 프로그램 및 응용 프로그램에서 사용할 수 있는 API형태로 기능을 노출 할 수 있습니다. 서비스 외부 게이트웨이는 이러한 서비스에 대한 액세스를 관리하고 트래픽 관리 및 보안 정책을 적용하여 마이크로 서비스 환경을 보호합니다. 외부 게이트웨이 기능은 종종 API 관리 제품을 사용하여 구현됩니다.
* 서비스 메쉬 기능 : 서비스 메쉬는 서비스 간의 통신을 느슨하게 결합, 신뢰성 및 유연성을 유지하는데 도움이되는 기능으로 구성됩니다. 이러한 기능을 통해 서비스 분리, 버전 관리 전략 지원 및 부하시 탄성 확장성 관리가 가능합니다.
  * 로드 밸런싱 : 각 마이크로서비스의 인스턴스는 확장성을 지원하기 위해 로드밸런싱이 필요하므로 로드밸런싱의 세밀성 및 구성은 각 서비스를 관리하는 팀에 의해 제어되어야 합니다.
  * 서비스 발견 : 서비스는 느슨하게 결합된 방식으로 검색 가능해야합니다. 서비스 검색은 일반적으로 서비스 레지스트리를 사용하여 구현되며, 이 서비스 레지스트리에서 마이크로 서비스 소유자는 런타임에 다른 서비스가 필요로하는 정보를 등록 및 구성하여 찾아서 호출 할 수 있습니다. 이것을 네트워크 수준의 DNS와 유사하게 생각할 수 있습니다. 서비스 발견은 또한 마이크로 서비스간에 존재할 종속성을 관리하는데 도움을 주며 환경 변화를 관리 할 때 중요합니다.
  * 구성 저장소 : 서비스 인스턴스는 마이크로서비스와 전체 환경과 관련된 구성을 공유해야합니다. 예를 들어 환경에 배포 된 마이크로서비스에는 서비스 검색 레지스트리의 위치와 로그 이벤트를 내보내는 위치를 파악하는 방법이 필요합니다. 마이크로서비스 환경의 분산 특성으로 인해 분산 키-값 저장소를 사용하여 구현되는 경우가 많습니다.
  * ID 공급자 : 서비스 인스턴스는 신뢰할 수 있는 ID를 사용하여 통신해야합니다. 서비스 메시는 이러한 ID를 제공하고 유효성을 검사합니다. 여기에는 외부 ID 공급자 또는 디렉터리와의 통합이 포함될 수 있습니다.
* 서비스 이미지 레지스트리 : 사용자 환경의 어딘가에는 빌드되고 테스트 된 서비스의 불변 이미지를 저장하는 레지스트리가 있습니다. 이 저장소에 사용되는 기술은 사용하는 배포 단위에 따라 다릅니다. 코드 저장소 (동적으로 생성 된 서비스의 경우), Docker 이미지 레지스트리, 이진 아티팩트 저장소 또는 VM 이미지의 BLOB(Binary Large Object) 기반 저장소 일 수 있습니다.
* 메시지 지향 미들웨어 : 가장 간단한 MSA 구현은 HTTP와 같은 동기식 프로토콜 또는 gRPC 또는 Thrift 보다 효율적인 프로토콜을 사용하여 지속 가능할 수 있습니다. 그러나 대부분의 MSA는 게시/가입 및 화재 및 잊어버리기와 같은 이벤트 및 메시지 중심 패턴을 지원하기 위해 비동기 메시징 채널이 필요합니다.
* 빌드 및 테스트 자동화 : MSA의 개발 민첩성 이점은 개발 출력 품질을 극대화하고 전달을 간소화하기 위해 개발주기에서 높은 수준의 빌드 및 테스트 자동화가 필요합니다.
* 배포 자동화 : 개발 민첩성 이점을 완전히 실현하려면 배포를 자동화해야합니다. 새롭거나 향상된 마이크로 서비스의 배포를 자동화 할뿐만 아니라 외부 아키텍처 자체의 변경 자동화(예: 배포의 일부로 서비스 라우팅, 로드 균형 조정, 서비스 검색 및 서비스 구성 데이터 업데이트)를 지원해야합니다.
* 플랫폼 자동화 : 마이크로서비스의 런타임 확장성과 적응성 이점을 실현하려면 외부 아키텍처에 기본 플랫폼과 관련된 자동화 기능 지원이 포함되어야 합니다. 여기에는 VM 또는 컨테이너의 프로비저닝 및 각 마이크로 서비스의 실행중인 인스턴스 관리가 포함됩니다.
* 모니터링 및 경고 : 분산 환경에서 문제가 발생할 때 모니터링 및 경고의 복잡성을 증가시킵니다. 외부 아키텍처는 일관되고 효율적으로 이를 수행 할 수 있는 기능을 제공해야합니다.
* 로깅 및 진단 : 분산 환경에서 문제가 발생하면 근본 원인을 식별하고 격리하기가 어려울 수 있습니다. 분산 된 프로세스의 추적을 포함하여 자세한 계측 및 진단 분석을 지원함으로써 외부 아키텍처는 마이크로서비스 팀이 문제를 보다 신속하게 분류하고 해결할 수 있도록 지원합니다.
* ID 제공 : 토큰 기반 서비스를 사용하여 인증 및 권한 부여를 외부화하는 것은 아전한 고객 대 서비스 및 서비스 대 서비스 상호 작용을 보장하는 것이 좋습니다.

### Client

마이크로서비스에 접근할 수 있는 API는 Web, Mobile, Speech, Service Partners, IoT등 다양합니다.

Client는 이런 다양한 형태의 API서비를 호출할 수 있으며 이를 통합하여 처리하는 서비스가 API Gateway입니다.

* API Gateway는 다음과 같은 형태의 Mediation을 제공합니다.

![msa10](https://user-images.githubusercontent.com/54675591/119954201-b7f49500-bfd9-11eb-8818-6d07112e6554.png)

위 이미지는 Consumer API vs Inner API간의 Mediation그리고 Service to Service 간의 Mediation을 설명하고 있습니다. Consumer API vs Inner API 간의 Mediation은 모니터링, 보안, 트래픽 관리, 경량 통합 및 수익 창출 기능이 포함됩니다.

Service to Service 간의 Mediation은 분산 구성 관리, 동적 검색, 요청 라우팅, 로드 균형 조정, 모니터링, 자가 치유 복원 서비스, 인증 및 권한 부여 및 메시지 암호화가 포함됩니다.

**Enterprise Gateway**는 서비스 주변 진입점에서 방어의 첫 번째 라인을 제공하고, API 소비자 사이의 트래픽을 관리하고 백엔드 중앙 집중식 모델을 사용합니다. 엔터프라이즈 게이트웨이의 예로는 Google Apigee 및 CA API관리가 있습니다.

**Microgateway**는 API를 엔드 포인트에서 last-mile 방어를 제공하기 위해 분산 모델을 사용합니다. 서비스가 어플리케이션 서버에 전개 될 때 API 소비자와 백엔드 서비스와 서비스 사이의 트래픽을 관리합니다. Microgateway의 예로 Kong과 Tyk가 있습니다.

**Service Mesh**는 클러스터 컨테이너 시스템에 배치 miniservices 및 microservices에 대한 서비스 간 통신을 관리하는 분산 모델을 사용합니다. 서비스 메쉬 기술의 예로는 Istio와 Linkerd가 있습니다.

* Service Mesh는 사실상 마이크로서비스의 핵심이라고 볼 수 있습니다.

![msa11](https://user-images.githubusercontent.com/54675591/119957815-651cdc80-bfdd-11eb-9483-51473653b1d1.png)

Service Mesh는 Miniservice 및 Microservice 환경 내에서 보안, 확장성 및 가용성을 향상시킵니다.

https://waspro.tistory.com/432?category=857035
