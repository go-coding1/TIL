# 프로젝트 7일차
# 오늘 해야할 것
- 에러페이지 적용 O
- 지금 사용하고 있는 SELECT문 파이프라인 적용해서 바꾸기 O
- 뉴스 업데이트, 삭제 프로시저 작성 O
- collection 업데이트, 삭제 프로시저 작성
- 브랜드별 콜렉션 참가 횟수 뷰 만들기 O
- 자바에 주석 달기
- 차트 화면 완성 o
- 관리자가 서블릿 호출했을때 검사하는 로직 추가하기 

# 에러페이지 적용 완료
web.xml 파일에 코드 추가해 주었음 단 지금 common_tit01.png 파일이 없어서 사진이 안나옴 는 한섬 에러페이지에서 사진 찾아서 넣었음

# select문 파이프라인 적용 완료 
- selectNewsList
```sql
-- 1. OBJECT타입 생성
CREATE OR REPLACE TYPE SELECT_NEWS_LIST_TYPE IS RECORD(
    RNUM        NUMBER,
    ID          NUMBER,
    TITLE       VARCHAR2(100),
    CREATE_DATE VARCHAR2(100),
    THUMNAIL_ID VARCHAR2(100),
    URI         VARCHAR2(100)
);

-- 2. 테이블 타입 객체 생성
CREATE OR REPLACE TYPE SELECT_NEWS_LIST_TABLE IS TABLE OF SELECT_NEWS_LIST_TYPE;

-- 3. pipelined table function 생성(테이블 리턴)
CREATE OR REPLACE FUNCTION F_SELECT_NEWS_LIST_TABLE(
    P_PAGEINDEX IN NUMBER
)RETURN SELECT_NEWS_LIST_TABLE PIPELINED
IS
    V_RSLT SELECT_NEWS_LIST_TYPE;
BEGIN
    FOR LIST_CUR IN(
        SELECT * 
          FROM ( SELECT ROWNUM AS RNUM, 
                        ID, 
                        TITLE,
                        TO_CHAR(CREATE_DATE, 'YYYY.MM.DD') as create_date,
                        THUMNAIL_ID, 
                        URI 
                   FROM (SELECT A.ID, 
                                A.TITLE,
                                CREATE_DATE, 
                                A.THUMNAIL_ID, 
                                B.URI 
                           FROM NEWS A, IMAGE B 
                          WHERE A.THUMNAIL_ID = B.ID 
                          ORDER BY CREATE_DATE DESC) 
                 ) 
            WHERE RNUM >=1+(P_PAGEINDEX-1)*6 AND RNUM <=6*P_PAGEINDEX
    )
    LOOP
        V_RSLT := SELECT_NEWS_LIST_TYPE(LIST_CUR.RNUM, LIST_CUR.ID, LIST_CUR.TITLE, LIST_CUR.CREATE_DATE, LIST_CUR.THUMNAIL_ID, LIST_CUR.URI);
        
        PIPE ROW(V_RSLT);
    END LOOP;
    EXCEPTION WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20001,'F_SELECT_NEWS_LIST_TABLEG함수 : 뉴스 SELECT시 에러 발생 '||SQLERRM);
    RETURN;
END;

```

- countNews
```sql
--1. OBJECT 타입 생성
CREATE OR REPLACE  TYPE COUNT_NEWS_TYPE IS RECORD(
    COUNT NUMBER
);

--2. 테이블 타입 객체 생성
CREATE OR REPLACE TYPE COUNT_NEWS_TABLE IS TABLE OF COUNT_NEWS_TYPE;

--3. piplined table function 생성(테이블 리턴)
CREATE OR REPLACE FUNCTION F_COUNT_NEWS
RETURN COUNT_NEWS_TABLE PIPELINED
IS
    V_RSLT COUNT_NEWS_TYPE;
BEGIN
    FOR COUNT_CUR IN (
        SELECT COUNT(*) AS COUNT
          FROM NEWS
    ) 
    LOOP
        V_RSLT := COUNT_NEWS_TYPE(COUNT_CUR.COUNT);
        PIPE ROW(V_RSLT);
    END LOOP;
    EXCEPTION WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20001, 'F_COUNT_NEWS함수 : 뉴스 count시 에러 발생 '||SQLERRM);
    RETURN;
END;
```
- selectNewsDet
```sql
--1. OBJECT 타입 생성
CREATE OR REPLACE  TYPE SELECT_NEWSDET_TYPE IS RECORD(
    ID NUMBER,
    TITLE VARCHAR2(100),
    CONTENT CLOB,
    IMAGE_ID VARCHAR2(100),
    URI VARCHAR2(100),
    CREATE_DATE VARCHAR2(100),
    PREV_ID VARCHAR2(100),
    PREV_TITLE VARCHAR2(100),
    NEXT_ID VARCHAR2(100),
    NEXT_TITLE VARCHAR2(100) 
);

--2. 테이블 타입 객체 생성
CREATE OR REPLACE TYPE SELECT_NEWSDET_TABLE IS TABLE OF SELECT_NEWSDET_TYPE;

--3. piplined table function 생성(테이블 리턴)
CREATE OR REPLACE FUNCTION F_SELECT_NEWSDET(
    P_NEWSID IN NUMBER
)
RETURN SELECT_NEWSDET_TABLE PIPELINED
IS
    V_RSLT SELECT_NEWSDET_TYPE;
BEGIN
    FOR LIST_CUR IN (
        SELECT A.ID, A.TITLE, A.CONTENT, A.IMAGE_ID, B.URI, TO_CHAR(A.CREATE_DATE, 'YYYY.MM.DD') AS CREATE_DATE, PREV_ID, PREV_TITLE, NEXT_ID, NEXT_TITLE 
          FROM (SELECT ID, TITLE, IMAGE_ID, CREATE_DATE, CONTENT, 
                       LAG(ID) OVER (ORDER BY CREATE_DATE DESC) as Prev_ID, 
                       LAG(title) OVER (ORDER BY CREATE_DATE DESC) as Prev_Title, 
                       LEAD(ID) OVER (ORDER BY CREATE_DATE DESC) as Next_ID, 
                       LEAD(title) OVER (ORDER BY CREATE_DATE DESC) as Next_title 
                  FROM NEWS) A, IMAGE B 
          WHERE A.ID = P_NEWSID
            AND A.IMAGE_ID = B.ID
    ) 
    LOOP
        V_RSLT := SELECT_NEWSDET_TYPE(LIST_CUR.ID, LIST_CUR.TITLE, LIST_CUR.CONTENT, LIST_CUR.IMAGE_ID, LIST_CUR.URI, LIST_CUR.CREATE_DATE, LIST_CUR.PREV_ID, LIST_CUR.PREV_TITLE, LIST_CUR.NEXT_ID, LIST_CUR.NEXT_TITLE);
        PIPE ROW(V_RSLT);
    END LOOP;
    EXCEPTION WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20001, 'F_SELECT_NEWSDET함수 : 뉴스DET SELECT시 에러 발생 '||SQLERRM);
    RETURN;
END;
```

- selectCollectionList
```sql
--1. OBJECT 타입 생성
CREATE OR REPLACE  TYPE SELECT_COLLECTION_LIST_TYPE IS RECORD(
    RNUM            NUMBER,
    COLLECTION_ID   NUMBER,
    SEASON_CD       VARCHAR2(100),
    NAME            VARCHAR2(100),
    THUMNAIL_ID     VARCHAR2(100),
    URI             VARCHAR2(100),
    COUNT           NUMBER
);

--2. 테이블 타입 객체 생성
CREATE OR REPLACE TYPE SELECT_COLLECTION_LIST_TABLE IS TABLE OF SELECT_COLLECTION_LIST_TYPE;

--3. piplined table function 생성(테이블 리턴)
CREATE OR REPLACE FUNCTION F_SELECT_COLLECTION_LIST(
    P_BRANDNAME IN VARCHAR2,
    P_INDEXPAGE IN NUMBER
)
RETURN SELECT_COLLECTION_LIST_TABLE PIPELINED
IS
    V_RSLT SELECT_COLLECTION_LIST_TYPE;
BEGIN
    FOR LIST_CUR IN (
        SELECT *
          FROM ( SELECT ROWNUM AS RNUM, 
                        A.ID AS COLLECTION_ID,  
                        A.SEASON_CD,  
                        A.NAME,      
                        B.ID AS THUMNAIL_ID,  
                        B.URI, 
                        COUNT(*) AS COUNT
                   FROM COLLECTION A, IMAGE B  
                  WHERE A.THUMNAIL_ID = B.ID  
                    AND A.NAME LIKE '%' || P_BRANDNAME || '%'  
                  GROUP BY A.ID, A.SEASON_CD, A.NAME, B.ID, B.URI, ROWNUM
                  ORDER BY ROWNUM ) 
           WHERE RNUM >=1+(P_INDEXPAGE-1)*8 AND RNUM <=8*P_INDEXPAGE
    ) 
    LOOP
        V_RSLT := SELECT_COLLECTION_LIST_TYPE(LIST_CUR.RNUM, LIST_CUR.COLLECTION_ID, LIST_CUR.SEASON_CD, LIST_CUR.NAME, LIST_CUR.THUMNAIL_ID, LIST_CUR.URI, LIST_CUR.COUNT);
        PIPE ROW(V_RSLT);
    END LOOP;
    EXCEPTION WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20001, 'F_SELECT_COLLECTION_LIST함수 : Collection select시 에러 발생 '||SQLERRM);
    RETURN;
END;
```
- selectCollectionBrandName
```sql
--1. OBJECT 타입 생성
CREATE OR REPLACE  TYPE SELECT_COLLECTION_BRAND_TYPE IS RECORD(
    NAME VARCHAR2(100)
);


--2. 테이블 타입 객체 생성
CREATE OR REPLACE TYPE SELECT_COLLECTION_BRAND_TABLE IS TABLE OF SELECT_COLLECTION_BRAND_TYPE;

--3. piplined table function 생성(테이블 리턴)
CREATE OR REPLACE FUNCTION F_SELECT_COLLECTION_BRAND_NAME
RETURN SELECT_COLLECTION_BRAND_TABLE PIPELINED
IS
    V_RSLT SELECT_COLLECTION_BRAND_TYPE;
BEGIN
    FOR LIST_CUR IN (
        SELECT DISTINCT NAME 
          FROM COLLECTION 
         ORDER BY NAME 
    ) 
    LOOP
        V_RSLT := SELECT_COLLECTION_BRAND_TYPE(LIST_CUR.NAME);
        PIPE ROW(V_RSLT);
    END LOOP;
    EXCEPTION WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20001, 'F_SELECT_NEWSDET함수 : 뉴스DET SELECT시 에러 발생 '||SQLERRM);
    RETURN;
END;
```
- countColllection
```SQL
--1. OBJECT 타입 생성
CREATE OR REPLACE  TYPE COUNT_COLLECTION_TYPE IS RECORD(
    COUNT NUMBER
);

--2. 테이블 타입 객체 생성
CREATE OR REPLACE TYPE COUNT_COLLECTION_TABLE IS TABLE OF COUNT_COLLECTION_TYPE;

--3. piplined table function 생성(테이블 리턴)
CREATE OR REPLACE FUNCTION F_COUNT_COLLECTION(
    P_BRANDNAME VARCHAR2
)
RETURN COUNT_COLLECTION_TABLE PIPELINED
IS
    V_RSLT COUNT_COLLECTION_TYPE;
BEGIN
    FOR COUNT_CUR IN (
        SELECT COUNT(*) as count 
         FROM (SELECT ROWNUM AS RNUM, 
                      A.ID AS COLLECTION_ID,  
                      A.SEASON_CD AS SEASON_CD,  
                      A.NAME AS NAME,  
                      B.ID AS THUMNAIL_ID,  
                      B.URI AS URI 
                 FROM COLLECTION A, IMAGE B  
                WHERE A.THUMNAIL_ID = B.ID  
                  AND A.NAME LIKE '%' || P_BRANDNAME || '%'  
                ORDER BY ROWNUM )
    ) 
    LOOP
        V_RSLT := COUNT_COLLECTION_TYPE(COUNT_CUR.COUNT);
        PIPE ROW(V_RSLT);
    END LOOP;
    EXCEPTION WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20001, 'F_COUNT_COLLECTION함수 : COLLECTION COUNT시 에러 발생 '||SQLERRM);
    RETURN;
END;

SELECT * FROM F_COUNT_COLLECTION(NULL);
```
- selectCollectionDet
```SQL
--1. OBJECT 타입 생성
CREATE OR REPLACE  TYPE SELECT_COLLECTION_DET_TYPE IS RECORD(
    IMAGE_ID VARCHAR2(100),
    URI VARCHAR2(100),
    SEASON_CD VARCHAR2(100),
    BRAND_NAME VARCHAR2(100)
);

--2. 테이블 타입 객체 생성
CREATE OR REPLACE TYPE SELECT_COLLECTION_DET_TABLE IS TABLE OF SELECT_COLLECTION_DET_TYPE;

--3. piplined table function 생성(테이블 리턴)
CREATE OR REPLACE FUNCTION F_SELECT_COLLECTION_DET(
    P_COLLECTION_ID IN NUMBER
)
RETURN SELECT_COLLECTION_DET_TABLE PIPELINED
IS
    V_RSLT SELECT_COLLECTION_DET_TYPE;
BEGIN
    FOR LIST_CUR IN (
        SELECT B.ID AS IMAGE_ID, 
               B.URI, 
               C.SEASON_CD, 
               C.NAME AS BRAND_NAME 
          FROM COLLECTION_IMAGES A, IMAGE B, COLLECTION C 
         WHERE A.IMAGE_ID = B.ID 
           AND C.ID = A.COLLECTION_ID 
           AND A.COLLECTION_ID = P_COLLECTION_ID
    ) 
    LOOP
        V_RSLT := SELECT_COLLECTION_DET_TYPE(LIST_CUR.IMAGE_ID, LIST_CUR.URI, LIST_CUR.SEASON_CD, LIST_CUR.BRAND_NAME);
        PIPE ROW(V_RSLT);
    END LOOP;
    EXCEPTION WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20001, 'F_SELECT_COLLECTION_DETT함수 : Collection DET select시 에러 발생 '||SQLERRM);
    RETURN;
END;

SELECT * FROM F_SELECT_COLLECTION_DET(40);
```

# 브랜드별 콜렉션 참가수, 시즌별 콜렉션 수 를 볼 수 있는 뷰 생성
```sql
CREATE OR REPLACE VIEW V_COLLECTION_STAT
AS 
    SELECT *
      FROM (SELECT COUNT(*) AS COLLECTION_COUNT,
                   DECODE(NAME, null, '합계', NAME ) AS NAME
              FROM COLLECTION
             GROUP BY CUBE(NAME)
             ORDER BY COLLECTION_COUNT),
           (SELECT COUNT(*) AS SEASON_COUNT ,
                   DECODE(SEASON_CD,null,'합계',SEASON_CD) AS SEASON_CD
              FROM COLLECTION
             GROUP BY CUBE(SEASON_CD)
             ORDER BY SEASON_COUNT)
    WITH READ ONLY
;
```

# 추가로 뷰를 조회하는 테이블 함수 생성
```sql
CREATE OR REPLACE TYPE SELECT_COLLECTION_STAT_TYPE IS RECORD(
    COUNT NUMBER,
    STAT_CD  VARCHAR2(100)
);

CREATE OR REPLACE TYPE SELECT_COLLECTION_STAT_TABLE IS TABLE OF SELECT_COLLECTION_STAT_TYPE;

CREATE OR REPLACE FUNCTION F_SELECT_COLLECTION_STAT(
    P_STAT_CD IN VARCHAR2 -- 1.SEASON 2.NAME
)
RETURN SELECT_COLLECTION_STAT_TABLE PIPELINED
IS
    V_RSLT SELECT_COLLECTION_STAT_TYPE;
BEGIN
    IF UPPER(P_STAT_CD) = 'SEASON' THEN
        BEGIN
            FOR LIST_CUR IN(
                SELECT SEASON_COUNT, SEASON_CD
                  FROM V_COLLECTION_STAT
                 GROUP BY (SEASON_COUNT,SEASON_CD)
                 ORDER BY SEASON_COUNT
            )
            LOOP
                V_RSLT := SELECT_COLLECTION_STAT_TYPE(LIST_CUR.SEASON_COUNT, LIST_CUR.SEASON_CD);
                PIPE ROW(V_RSLT);
            END LOOP;
        END;
    ELSIF UPPER(P_STAT_CD) = 'NAME' THEN
        BEGIN
            FOR LIST_CUR IN(
                SELECT COLLECTION_COUNT,NAME
                FROM V_COLLECTION_STAT
                group by (COLLECTION_COUNT,NAME)
                ORDER by COLLECTION_COUNT   
            )
            LOOP
                V_RSLT := SELECT_COLLECTION_STAT_TYPE(LIST_CUR.COLLECTION_COUNT, LIST_CUR.NAME);
                PIPE ROW(V_RSLT);
            END LOOP;
        END;
    ELSE
        BEGIN
            RAISE_APPLICATION_ERROR(-20001,'F_SELECT_COLLECTION_STAT함수 : 오바른 파라미터 값을 넣지 않았습니다. SEASON, NAME 둘중 하나를 파라미터로 사용해주세요.');
            RETURN;
        END;
    END IF;
    
    EXCEPTION WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20001,'F_SELECT_COLLECTION_STAT함수 : '||P_STAT_CD||'조회시 에러 발생 '||SQLERRM);
    RETURN;
END;

select * from F_SELECT_COLLECTION_STAT('name');
```

# 차트 화면 완성함
교수님이 주신 예제와 실제 구글 차트의 버전 차이 때문인지 약간의 사용방법이 달랐음

# NEWS UPDATE DELETE 프로시저 작성 완료

# NEWS DELETE 하는 화면 완성

# COLLECTION delete프로시저 작성 완료 및 삭제 화면완성 